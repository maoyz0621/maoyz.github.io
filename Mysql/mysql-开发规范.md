Mysql开发规范

# 一、命名

不要用SQL保留字来命名库、表、视图、字段、索引。数据库的关键字请参考相关资料。

## 1、库名

- 库的名称必须控制在32个字符以内，相关模块的表名与表名之间尽量提现join的关系，如user表和user_login表。
- 库的名称格式：业务系统名称_子系统名，同一模块使用的表名尽量使用统一前缀。
- 一般分库名称命名格式是库通配名编号，编号从0开始递增，比如wenda_001以时间进行分库的名称格式是“库通配名时间”
- 创建数据库时必须显式指定字符集，并且字符集只能是utf8或者utf8mb4。创建数据库SQL举例：create database db1 default character set utf8


## 2、表名

- 小写字母加下划线分割，表名不使用复数名词,  如mall_user
- 使用英文名词，不能用拼音，且使用业界通用单词而不是生僻词
- 分库分表时，表名加数字后缀，如mall_user1,mall_user2


## 3、字段名

- 尽量用完整单词，能理解字段含义
- 使用简写时用常规简写，不用非主流简写，如org表示organization合理
- 字段名不能过长，1-3个单词
- 字段命名时，属于同一个实体时，名字不带实体，比如表名为user，姓名字段为name，而不是user_name
- 任何表达是否概念的字段, 须要使用 is_xxx 方式命名


4、索引名

- 普通索引用‘idx_’开头，后续接相关字段加下划线，如idx_name_age
- 唯一索引用'uk_'开头，后续接相关字段加下划线，如uk_name_age
- 主键索引用'pk_'开头，后续接相关字段加下划线，如pk_name_age



# 二、索引

## A 索引设计规范：

1、表必须有主键索引，PRIMARY KEY (id)

2、如果业务上某些字段有唯一性约束就必须建唯一索引

3、如果需要有外键约束的，必须在外建上创建索引

## B 索引设计原则：

1、索引尽量少（最好不要超过7个），索引过多；索引虽然提高了查询速度，但在对于表的insert,update,delete等操作时却是降低了维护速度增加了维护的难度；

2、建立索引尽量满足左匹配，索引只能命中最左边的范围查询比如存在索引idx_a_b_c_d,  查询如select * from table where a=1 and b=2 and c>3 and d<4，则只能用到a,b,c

3、使用explain查看执行计划，需求所有的查询至少到达range级别

4、区分度不高的字段不建索引，禁止在低基数列上建索引，比如性别，只有男和女，这种字段不需要建索引

5、建立索引时，把区分度高的字段放在前面，如 id 和 time id是唯一的。所以建索引的时候 id 须在前面

6、避免对经常更新的表进行过多的索引，并且索引应保持较窄，就是说，列要尽可能少
7、如果业务上某些字段有唯一性约束就必须建唯一索引

8、经常被用作查询选择的字段、被用来作为排序基准（order by、group by、distinct后面的字段）的字段、在查询中用来连接表的字段、在union等集合操作的结果集字段，需要为其建立索引

9、内容很少变动，但经常被查询的表，按照查询条件创建索引

10、经常性、例行性变动的表，则需要谨慎地创建确实必要的索引

11、不允许动态创建索引

12、更新频繁的列上不建索引

13、重要SQL必须使用索引

14、UPDATE 、DELETE语句必须有WHERE谓词

15、ORDER BY,GROUP BY ,DISTINCT字段需建索引

16、多JOIN字段需要使用索引

17、核心SQL优先考虑组合索引（覆盖索引）

18、禁止重复索引和冗余索引

19、禁止在索引列进行数学运算和函数运算

20、禁止使用外键（常规理由外，INNODB 对ONLINE DDL有限制）

21、禁止使用%前导查询，如LIKE  ‘%XX‘

22、禁止使用负向查询，如 NOT  IN/LIKE(全表会导致BUFFER POOL复用率降低)

## C 索引维护：

1、定期检查索引表空间

2、检查是否需要重新建立索引

3、定期做索引的碎片整理

4、定期检查索引是否失效

5、定期进行表分析

6、删除不再使用，或者很少被使用的索引

# 三、表

1、设计表先垂直划分，每个表的内容尽量独立，数据量大再考虑水平划分

2、表中的字段不能过多，太宽要考虑拆表，一行的占用空间越小越好，小于15个（不包括通用）

3、每一行的长度必须定长，而不能含有变长字段，方便定长寻址

4、表必须有注释

5、创建表时必须显式指定字符集为utf8或utf8mb4

6、表级定义默认如下：ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

7、创建表时必须显式指定表存储引擎类型，如无特殊需求，一律为InnoDB。当需要使用除InnoDB/MyISAM/Memory以外的存储引擎时，必须通过DBA审核才能在生产环境中使用。因为Innodb表支持事务、行锁、宕机恢复、MVCC等关系型数据库重要特性，为业界使用最多的MySQL存储引擎。而这是其他大多数存储引擎不具备的，因此首推InnoDB，使用别的存储引擎需要专门讨论审核

8、不要建立分区表，特别业务需要时则需要讨论及审核通过

9、中间表用于保留中间结果集，名称必须以tmp开头。备份表用于备份或抓取源表快照，名称必须以bak开头。中间表和备份表定期清理

10、反范式设计：把经常需要join查询的字段，在其他表里冗余一份。如user_name属性在user_account，user_login_log等表里冗余一份，减少join查询。

11、表和列的名称必须控制在32个字符以内，表名只能使用字母、数字和下划线，一律小写

12、表名要求模块名强相关，如师资系统采用”sz”作为前缀，渠道系统采用”qd”作为前缀等

# 四、字段

1、数据类型

- 数据类型尽量用内存占用少的类型，比如状态用tinyint而不是bigint
- 任何字段如果为非负数，必须是 unsigned
- varchar必须指定长度，且不能超过2048
- 如果存储的字符串长度几乎相等，使用 char 定长字符串类型
- 时间类型用datetime，而不是timestamp
- IP地址用32位整形，unsigned int，而不是字符串
- text/blob类型，用扩展表存储
- 小数类型使用decimal

2、表中所有字段必须都是NOT NULL属性，业务可以根据需要定义DEFAULT值。因为使用NULL值会存在每一行都会占用额外存储空间、数据迁移容易出错、聚合函数计算结果偏差等问题

3、字段必须有注释

4、枚举字段，存数字，枚举类定义{int id,String name}

5、字符型字段的确定。长度固定用char，不固定用varchar，但基本上多数可用VARCHAR但需要指定字段数，而不是默认值

6、字段设计时不使用TEXT，BLOB类型

7、拆分大字段与访问频率低的字段，冷热数据分离

8、禁止在数据库表中中存储明文密码

9、业务中选择性很少的状态status、类型type等字段推荐使用tinytint或者smallint类型节省存储空间

10、存储金钱的字段，建议用int，程序端乘以100和除以100进行存取。因为int占用4字节，而double占用8字节，空间浪费

# 五、SQL

1、sql不能太过于复杂

2、尽量用批量查询，不是循环调用单次查询接口

3、避免select *，尽量使用索引覆盖，且只查询需要的字段；因为 select * 会将不该读的数据也从MySQL里读出来，造成网卡压力。且表字段一旦更新，但model层没有来得及更新的话，系统会报错

4、insert语句指定具体字段名称，不要写成insert into t1 values(…)，道理同select 语句

5、不要使用 count(列名)或 count(常量)来替代 count(*)，count(*)是 SQL92 的规范

6、统计数据量时，范围不能太广，数据量不能超过100w

7、查询记录只有一条时，需要加limit 1

8、查询记录多条时，都统一加limit 1000

9、使用limit进行分页时，深度越深，效率越低。

10、使用limit尽量不要深度翻页，一般采用从上一页的id开始，逐页进行翻页

11、批量插入和删除时，一次的数量不能超时1000，如果超过了，应考虑分批处理

12、禁止使用物理外键，超过三个表禁止join。需要join的字段，数据类型必须绝对一致

13、禁止使用存储过程、触发器、游标

14、尽量避免使用or，可以改为in

15、in值列表限制在500以内。例如select… where userid in(….500个以内…)，这么做是为了减少底层扫描，减轻数据库压力从而加速查询

16、在varchar字段上建立索引时，必须指定索引长度

17 、页面搜索尽量不要使用左模糊或者全模糊，可考虑使用搜索引擎实现

18、避免使用不等于操作符如：<>、!=

19、where条件等号两边字段类型必须相同

20、insert into…values(XX),(XX),(XX)…。这里XX的值不要超过5000个。值过多虽然上线很很快，但会引起主从同步延迟

21、SELECT语句不要使用UNION，推荐使用UNION ALL，并且UNION子句个数限制在5个以内。因为union all不需要去重，节省数据库资源，提高性能

22、索引列不要使用函数或表达式，否则无法利用索引。如where length(name)='Admin'或where user_id+2=10023

23、事务里批量更新数据需要控制数量，进行必要的sleep，做到少量多次

24、除静态表或小表（100行以内），DML语句必须有where条件，且使用索引查找

25、事务涉及的表必须全部是innodb表。否则一旦失败不会全部回滚，且易造成主从库同步终端

26、where条件里等号左右字段类型必须一致，否则无法利用索引

27、SELECT|UPDATE|DELETE|REPLACE要有WHERE子句，且WHERE子句的条件必需使用索引查找

28、生产数据库中强烈不推荐大表上发生全表扫描，但对于100行以下的静态表可以全表扫描。查询数据量不要超过表行数的25%，否则不会利用索引

29、减少使用or语句，可将or语句优化为union，然后在各个where条件上建立索引。如where a=1 or b=2优化为where a=1… union …where b=2, key(a),key(b)

30、分页查询，当limit起点较高时，可先用过滤条件进行过滤。如select a,b,c from t1 limit 10000,20;优化为: select a,b,c from t1 where id>10000 limit 20;

# 六、优化建议

1、利用查询缓存，相同的sql语句，不用重复解析，且从缓存中获取

2、利用预编译语句，防止sql注入，且能有效利用缓存

3、每一列的字段越小越好，如果只是日期就用data而不是datetime，如果状态字段，就用tinyint而不是bigint

4、引擎的选择，查多写少可以考虑myisam，myisam对于select count(1)等统计效率很高；写多考虑innodb，一般建议用innodb

5、禁止跨db的join语句。因为这样可以减少模块间耦合，为数据库拆分奠定坚实基础

6、禁止在业务的更新类SQL语句中使用join，比如update t1 join t2…

7、线上环境，多表join不要超过3个表

8、在多表join中，尽量选取结果集较小的表作为驱动表，来join其他表

9、事务中INSERT|UPDATE|DELETE|REPLACE语句操作的行数控制在2000以内，以及WHERE子句中IN列表的传参个数控制在500以内

10、程序设计必须考虑“数据库事务隔离级别”带来的影响，包括脏读、不可重复读和幻读。线上建议事务隔离级别为repeatable-read

11、减少使用order by，和业务沟通能不排序就不排序，或将排序放到程序端去做。order by、group by、distinct这些语句较为耗费CPU，数据库的CPU资源是极其宝贵的

12、order by、group by、distinct这些SQL尽量利用索引直接检索出排序好的数据。如where a=1 order by可以利用key(a,b)

13、包含了order by、group by、distinct这些查询的语句，where条件过滤出来的结果集请保持在1000行以内，否则SQL会很慢

# 七、数据库操作行为规范

1、禁止在线上执行后台管理和统计类查询

2、 禁止有super权限的应用程序账号存在（尽可能缩小应用帐号权限）

3、禁止实例开启时，使用MYSQL DUMP 恢复数据库，删除数据库（操作时需要其他成员配合，完成整个项目的数据库链正确）需要这种操作，需要方案审批

4、产品出现非数据库导致的故障时及时通知DBA协助排查

5、在编写建表语句时，需同时考虑回滚、以及必要的初始化语句；生产环境变更表或数据时须提供变更和回滚sql文件

6、推广活动或上线新功能须提前通知DBA做数据库类性能监控和应急

7、数据库数据丢失，及时联系DBA进行恢复

8、对单表的多次alter操作必须合并为一次操作

9、不在MySQL数据库中存放业务逻辑

10、重要项目的数据库方案选型和设计必须提前通知DBA参与

11、不在业务高峰期批量更新、查询数据库

12、提交线上建表改表需求，必须详细注明所有相关SQL语句


《参考文档》

1、https://onextrapixel.com/20-tips-and-tricks-any-mysql-database-developer-should-consider/
2、https://code.tutsplus.com/tutorials/top-20-mysql-best-practices--net-7855
3、https://www.monitis.com/blog/101-tips-to-mysql-tuning-and-optimization/
4、https://github.com/jly8866/archer/blob/master/src/docs/mysql_db_design_guide.md
