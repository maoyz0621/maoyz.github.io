# Redis

## Redis 4

### 内存淘汰策略

添加了**LFU**（Least Frequently Used）,对已有的淘汰策略进行了优化。

- **allkeys-lfu**：淘汰整个键值中最少使用使用频率最低的的键值。（4.0之后）
- **volatile-lfu**：淘汰所有设置了过期时间的键值中，使用频率最低的键值；（4.0之后）

### Lazy FREE

用户在使用 DEL命令删除体积较大的键， 又或者在使用 **FLUSHDB** 和 **FLUSHALL**删除包含大量键的数据库时， 都可能会造成服务器阻塞。

新添加了**UNLINK**命令， 这个命令是DEL命令的异步版本， 它可以将删除指定键的操作放在后台线程里面执行， 从而尽可能地避免服务器阻塞：

执行`rename oldkey newkey`时，如果`newkey`已经存在，Redis会先删除已经存在的`newkey`，这也会引发可能的删除大key问题。可以按如下配置：

```
lazyfree-lazy-server-del yes
```

### RDB-AOF 混合持久化

新增了`RDB-AOF`混合持久化格式， 这是一个可选的功能， 在开启了这个功能之后， AOF 重写产生的文件将同时包含 RDB 格式的内容和 AOF 格式的内容， 其中 **RDB 格式的内容用于记录已有的数据， 而 AOF 格式的内存则用于记录最近发生了变化的数据**， 这样 Redis 就可以同时兼有 RDB 持久化和 AOF 持久化的优点 —— 既能够快速地生成重写文件， 也能够在出现问题时， 快速地载入数据。

配置项开启：`aof-use-rdb-preamble  yes`

### 内存命令

`MEMORY`查看内存使用情况

### PSYNC 2.0

- 在旧版本中，如果一个从服务器在 FAILOVER 之后成为了新的主节点，那么其它从节点在复制这个新主的时候就必须进行**全量复制**。在Redis 4.0中，新主和从服务器在处理这种情况时，将在条件允许的情况下使用**部分复制**。
- 在旧版本中，一个从服务器如果重启了，那么它就必须与主服务器重新进行**全量复制**， 在Redis 4.0中， 只要条件允许，主从在处理这种情况时将使用部分复制。
- 在旧版本中，当复制为链式复制的时候，如 A—>B—>C ，主节点为A。当A出现问题，C节点不能正常复制B节点的数据。当提升B为主节点，C需要全量同步B的数据。在PSYNC2：PSYNC2解决了链式复制之间的关联性。A出现问题不影响C节点，B提升为主C不需要全量同步。
- 在使用星形复制时，如一主两从。A—>B , A—>C ，主节点为A。当A出现问题，B提升为主节点，C重新指向主节点B。使用同步机制PSYNC2，C节点只做增量同步即可。在使用Sentinel故障转移可以较少数据重新同步的延迟时间，避免大redis同步出现的网络带宽占满。

## Redis 5

### Stream

新增Stream类型。

### 集群管理

redis3.x和redis4.x的集群管理主要依赖基于Ruby的`redis-trib.rb`脚本，redis5.0彻底抛弃了它，将集群管理功能全部集成到完全用C写的`redis-cli`中。可以通过命令`redis-cli --cluster help`查看帮助信息。

### RDB格式变化

Redis5.0开始，RDB快照文件中增加存储key逐出策略`LRU`和`LFU`：

- LRU(Least Recently Used)：最近最少使用。长期未使用的数据，优先被淘汰。
- LFU(Least Frequently Used)：最不经常使用。在一段时间内，使用次数最少的数据，优先被淘汰。

Redis5.0的RDB文件格式有变化，向下兼容。因此如果使用快照的方式迁移，可以从Redis低版本迁移到Redis5.0，但不能从Redis5.0迁移到低版本。

## Redis 6

### 多线程IO

Redis的多线程部分只是用来**处理网络数据的读写和协议解析**，执行命令仍然是单线程顺序执行。所以我们不需要去考虑控制 key、lua、事务，LPUSH/LPOP 等等的并发及线程安全问题。

Redis6.0的**多线程默认是禁用**的，只使用主线程。

如需开启需要修改redis.conf配置文件：`io-threads-do-reads yes`。

开启多线程后，还需要设置线程数，否则是不生效的。修改redis.conf配置文件：`io-threads` ，

> 关于线程数的设置，官方有一个建议：4核的机器建议设置为2或3个线程，8核的建议设置为6个线程，线程数一定要小于机器核数。还需要注意的是，线程数并不是越大越好，官方认为超过了8个基本就没什么意义了。

