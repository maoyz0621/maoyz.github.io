- 线上MQ如何保证消息不丢失？

生产者ACK机制

消息持久化

消息自动重试机制

- 线上MQ如何保证消息不被重复消费？

MQ保证消息至少被消费一次




```mysql
CREATE TABLE `event_fail_compensate` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `biz_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '业务id',
  `biz_system` varchar(255) DEFAULT NULL COMMENT '业务系统',
  `event_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '事件名称',
  `event_method` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '事件方法（bean的方法名）',
  `event_content` text COMMENT '消息内容',
  `event_status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '事件补偿状态:  0-待执行，1-执行中，2-执行成功，3-取消执行，4-执行失败',
  `retry_times` tinyint(4) NOT NULL DEFAULT '1' COMMENT '重试次数',
  `wait_time` varchar(0) DEFAULT NULL COMMENT '重试时间间隔 ,分割  10,60,300',
  `next_retry_time` datetime DEFAULT NULL COMMENT '下次重试时间',
  `max_retry_times` tinyint(4) NOT NULL DEFAULT '1' COMMENT '最大重试次数',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='事件失败补偿表';
```

