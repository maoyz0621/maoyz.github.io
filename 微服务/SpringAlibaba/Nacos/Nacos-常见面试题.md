# Nacos-常见面试题

## Nacos中的保护阈值的作用是什么？

Nacos提供了保护阈值这个功能，我们可以给某个服务设置一个0-1的阈值，比如0.5，那就表示，一旦实例中只剩下一半的健康实例了，比如10个实例，只剩下5个健康实例了，那么消费者在进行服务发现时，则会把**该服务的所有实例，也包括不健康的实例都拉取到本地**，然后再从所有实例中进行负载均衡，选出一个实例进行调用，在这种情况下，选出来的即可能是一个健康的实例，也可能是挂掉的实例，但是通过这种方式，很好的保护的剩下的健康实例，至少保证了一部分请求能正常的访问，而不至于所有请求都不能正常访问，这就是Nacos中的保护阈值，同时，这个功能在Spring Cloud Tencent中叫全死全活。



## Nacos的就近访问是什么意思？

首先，在Nacos中，一个**服务可以有多个实例**，并且可以给**实例设置cluster-name**，就是可以再进一步的给所有实例划分集群，那如果现在某个服务A想要调用服务B，那么Naocs会看调用服务A的实例是**属于哪个集群的**，并且调用服务B时，那就会调用同样集群下的服务B实例，根据**cluster-name来判断两个实例是不是同一个集群，这就是Nacos的就近访问。**



## **Nacos中的负载均衡是怎么样的？**

Nacos的**负载均衡**指的是，在进行**服务发现时进行负载均衡**，正常情况下，在进行服务发现时，会根据**服务名**从Nacos中拉取所有的**实例信息**，但是Nacos中提供了一个功能，就是可以在拉取实例时，可以根据**随机策略只拉取到所有实例中的某一个**，这就是Nacos中的负载均衡，它跟Ribbon的负载均衡并不冲突，**可以理解为Ribbon的负载均衡是发生在Nacos的负载均衡之后的。**



## 你觉得注册中心应该是CP还是AP？

我觉得大部分情况下，注册中心应该是AP，如果注册中心是CP，那么表示，当我们向注册中心注册实例或移除实例时，都要等待注册中心集群中的数据达到一致后，才算注册或移除成功，而这是比较耗时的，随着业务应用规模的增大，应用频繁的上下线，那么就会导致注册中心的压力比较大，会影响到服务发现的效率以及服务调用了。

而如果注册中心是AP，那么注册中心集群不管出现了什么情况，都是可以提供服务的，就算集群节点之间数据出现了不一致，对于业务应用而言，可能拉取到了一个已经下线了的服务节点，但是现在一般的微服务框架或组件都提供了服务容错和重试功能，也可以避免这个问题，而如果是AP，对于注册中心而言就不需要消耗太多的资源来实时的保证数据一致性了，保证最终一致性就可以了，这样注册中心的压力会小一点。

另外像Zookeeper来作为注册中心，因为Zookeeper保证的就是CP，但是如果集群中如果大多数节点挂掉了，就算还剩下一些Zookeeper节点，这些节点也是不能提供服务的，所以这个也不太合适，所以综合来看，注册中心应该保证AP会更好，就像Euraka、Nacos他们默认保证的就是AP。



## 为什么要将服务注册到nacos?

将服务注册到Nacos可以提供**服务发现、负载均衡、动态配置管理、服务健康检查**等功能，帮助应用实现高可用、可扩展和灵活的架构。



## Nacos服务是如何判定服务实例的状态？

1. **心跳检测：**Nacos会定期向每个注册的服务实例发送心跳请求，以检测其是否存活。如果Nacos在一段时间内没有收到实例的心跳回复，就会将该实例标记为不可用。
2. **健康检查：**Nacos可以配置一些健康检查的规则，例如HTTP接口的**返回状态码、响应时间**等。Nacos会定期调用这些接口，根据返回结果来判断服务实例的健康状况。如果实例返回的结果不符合预期的健康规则，Nacos会将其标记为不可用。
3. **负载均衡：**Nacos还会根据实例的负载情况来判定其状态。如果某个实例的负载过高，超过了一定的阈值，Nacos可能会将其标记为不可用，以避免过多的请求落在该实例上，导致服务质量下降。



## 在Nacos中服务提供者是怎样向Nacos注册核心(Registry)续约的？

1. 配置服务提供者的注册信息：服务提供者需要在配置文件中指定Nacos注册中心的地址和端口号。这些信息将用于与注册中心建立连接。
2. 建立与注册中心的连接：服务提供者通过使用Nacos提供的客户端SDK，与注册中心建立连接。SDK会提供相应的API来实现此功能。
3. 注册服务：服务提供者将自己的服务信息注册到Nacos注册中心。这些信息包括服务名称、IP地址、端口号等。注册中心将会保存这些信息，并提供给服务消费者使用。
4. 续约服务：在服务提供者启动后，它会定时向注册中心发送心跳请求，以告知注册中心该服务仍然可用。这个过程被称为续约。续约的频率可以通过配置进行调整。
5. 处理续约失败：如果服务提供者的续约请求失败，可能是由于网络故障或注册中心不可用等原因。在这种情况下，服务提供者将会尝试重新建立与注册中心的连接，并重新进行续约操作。



## Nacos如何支撑数十万服务注册压力？

Nacos内部接收到注册的请求时，不会立即写数据，而是**将服务注册的任务放入一个阻塞队列就立即响应给客户端**。然后利用线程池读取阻塞队列中的任务，异步来完成实例更新，从而提高并发写能力。



## Nacos如何避免并发读写冲突问题？

Nacos在更新实例列表时，会采用**CopyOnWrite**技术，**首先将旧的实例列表拷贝一份，然后更新拷贝的实例列表，再用更新后的实例列表来覆盖旧的实例列表**。

这样在更新的过程中，就不会对读实例列表的请求产生影响，也不会出现脏读问题了。



## Nacos与Eureka的区别有哪些？

Nacos与Eureka有相同点，也有不同之处：

- 接口方式：Nacos与Eureka都对外暴露了Rest风格的API接口，用来实现服务注册、发现等功能
- 实例类型：Nacos的实例有永久和临时实例之分；而Eureka只支持临时实例
- 健康检测：Nacos对**临时实例采用心跳模式**检测，对**永久实例采用主动请求**来检测；Eureka只支持**心跳模式**
- 服务发现：Nacos支持**定时拉取和订阅推送**两种模式；Eureka只支持**定时拉取**模式

