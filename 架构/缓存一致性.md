# 缓存和数据库一致性问题



## 引入缓存提高性能



## 缓存利用率和一致性问题

缓存中只保留最近访问的「**热数据**」



先更新缓存，后更新数据库

先更新数据库，后更新缓存



两个线程要修改「同一条」数据，每个线程在修改之前，先去申请分布式锁，拿到锁的线程才允许更新数据库和缓存，拿不到锁的线程，返回失败，等待下次重试。

只允许一个线程去操作数据和缓存，避免并发问题。



缓存利用率不高，还会造成机器性能的浪费。



## 删除缓存

1. ~~先删除缓存，后更新数据库~~
2. 先更新数据库，后删除缓存





## 主从库延迟和延迟双删



「先更新数据库，再删除缓存」



「读写分离 + 主从复制延迟」



**并发「读写」**

**缓存延迟双删策略**



| <img src="..\架构\image\image-20221228230941540.png" alt="image-20221228230941540" style="zoom: 67%;" /> |
| :----------------------------------------------------------: |
|                                                              |

**异步重试**