# 网关

## 签名校验

根据既定的签名规则对参数进行加密防止API在调用过程中被恶意者拦截随意篡改，在网关会使用同样的规则对请求的参数进行加密，再对比Header中的的签名和加密结果进行对比，相同则通过，反之抛出异常。

**签名规则：**

1. 将所有请求参数及Header中通用参数按照字母先后顺序排列，如果是复杂对象则将对象中的复杂类型转换成标准JSON。
2. 把所有参数名和参数值进行拼接。
3. 把应用密钥clientSecret通过MD5加密之后夹在字符串的两端。
4. 使用MD5进行不可逆加密。

Header参数：
- timestamp     时间戳，格式为yyyy-MM-dd HH:mm:ss，时区为GMT标准时间
- clientId           客户端应用的clientId
- sign                 访问签名
- apiVersion     API协议版本
- appId              调用方APPID
- random          请求随机数

## 熔断降级

当大量请求进入网关，向后端远程系统或服务发起调用，可能由于网关资源限制或者由于后端服务不可避免的会产生调用失败（超时或者异常），网关需要对请求快速失败并返回回去。

当后台服务处理数据过慢导致请求堆积在网关导致网关资源耗尽但未达到限流临界值时，会影响后续请求。

当后端服务在短时间内接口请求失败率达到临界值时可以阻止网关转发请求。

使用阿里开源框架sentinel。

## 平滑限流

服务限流其实是指当系统资源不够，不足以应对大量请求，即系统资源与访问量出现矛盾的时候，我们为了保证有限的资源能够正常服务，因此对系统按照预设的规则进行流量限制，限流策略为最流行的令牌桶方法。令牌桶方法规则如下：

1. 所有的请求在处理之前都需要拿到一个可用的令牌才会被处理；
2. 根据限流大小，设置按照一定的速率往桶里添加令牌，且桶设置最大的放置令牌限制，当桶满时、新添加的令牌就被丢弃或者拒绝；
3. 请求达到后首先要从桶中获取令牌，获取令牌成功，执行请求；获取令牌时间，拒绝请求。；

## 请求鉴权

客户端访问接口需要进行认证及鉴权

1. **认证：**客户端系统对接前首先申请一个clientId和clientSecret。客户端在发起请求时会先通过网关调用认证服务获取一个访问凭证，后续每次访问都携带凭证，网关通过校验凭证判断客户端是否为被认证的。认证通过进行访问，认证不通过抛出异常。

   认证服务使用的都为JWT作为凭证。

   > 认证服务的数据库标准表结构：https://andaily.com/spring-oauth-server/db_table_description.html

2. **鉴权：**客户端应用在通过认证后，网关通过认证信息获取客户端应用拥有哪些开放接口的权限并判断是否有访问当前请求的开放接口的权限。如果有则通过，反之抛出异常。

## 时间校验

从请求Header中获取到请求发起的时间戳timestamp（标准时间格式为yyyy-MM-dd HH:mm:ss），将时间戳与网关接收到请求的时间戳进行比较，如果在网关接受时间之前且在五分钟之内则通过，反之抛出异常。

## 防重请求

从请求Header中获取到携带的随机数random，将随机数作为key通过redis的getSet方法设置redis的值并且设置有效时间ns，同时根据返回值判断key是否存在判断是否为重复请求，如果为nil则通过，反之抛出异常。

## 日志记录

异步调用日志记录服务。日志会记录当前请求的路径，请求开始时间，请求结束时间，请求时长，请求参数，请求结果等必要参数。